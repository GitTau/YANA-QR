<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Scanner</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>QR Scanner</h1>
    <p class="muted">Scan scooters and batteries to assign or return them.</p>

    <div class="panel">
      <h2>Camera</h2>
      <video id="preview" autoplay playsinline></video>
      <p id="status">Initializing camera...</p>
      <button class="btn secondary" id="signOutBtn">Sign Out</button>
    </div>

    <div class="panel" id="assignments">
      <h2>Current Assignments</h2>
      <p>Scooter: <span id="currentScooter">None</span></p>
      <p>Battery: <span id="currentBattery">None</span></p>
    </div>

    <div class="panel">
      <h2>Logs</h2>
      <div id="logs"></div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Firebase + ZXing -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const toast = msg => { const t=document.getElementById("toast");t.innerText=msg;t.style.display="block";setTimeout(()=>t.style.display="none",3000);};

    let currentUser = null;
    let lastScan = "";

    // Sign out
    document.getElementById("signOutBtn").addEventListener("click", () => {
      auth.signOut().then(()=>window.location.href="homepage.html");
    });

    // Auth state
    auth.onAuthStateChanged(async user=>{
      if(!user){
        window.location.href="rider-signin.html";
        return;
      }
      currentUser = user;
      const snap = await db.collection("users").doc(user.email).get();
      if(!snap.exists || snap.data().status!=="approved"){
        toast("You are not approved to use the scanner.");
        auth.signOut();
        return;
      }
      setupRealtimeAssignments(user.email);
      startScanner();
      loadLogs(user.email);
    });

    // Realtime updates of scooter/battery
    function setupRealtimeAssignments(email){
      db.collection("users").doc(email).onSnapshot(doc=>{
        const data=doc.data()||{};
        document.getElementById("currentScooter").innerText = data.scooterId||"None";
        document.getElementById("currentBattery").innerText = data.batteryId||"None";
      });
    }

    // Load last 10 logs
    function loadLogs(email){
      db.collection("logs").where("email","==",email)
        .orderBy("timestamp","desc").limit(10)
        .onSnapshot(snap=>{
          const logs=document.getElementById("logs");
          logs.innerHTML="";
          snap.forEach(doc=>{
            const d=doc.data();
            const div=document.createElement("div");
            div.className="log";
            div.innerText=`[${d.timestamp?.toDate().toLocaleString()||""}] ${d.type} ${d.deviceId} → ${d.action}`;
            logs.appendChild(div);
          });
        });
    }

    // Scanner
    function startScanner(){
      const codeReader = new ZXing.BrowserQRCodeReader();
      codeReader.decodeFromVideoDevice(null,"preview",(result,err)=>{
        if(result){
          const code=result.text.trim();
          if(code!==lastScan){ lastScan=code; handleScan(code); }
        }
      });
    }

    // Handle QR scan
    async function handleScan(code){
      if(!currentUser) return;
      const email=currentUser.email;
      const ref=db.collection("users").doc(email);
      const snap=await ref.get();
      const data=snap.data()||{};
      const isScooter=code.startsWith("SCOOTER");
      const isBattery=code.startsWith("BATTERY");

      if(isScooter){
        if(data.scooterId && data.scooterId!==code){
          toast("Return your current scooter first.");
          return;
        }
        if(data.scooterId===code){
          await ref.update({scooterId:firebase.firestore.FieldValue.delete()});
          await logAction(email,code,"scooter","returned");
          toast("Scooter returned.");
        } else {
          await ref.update({scooterId:code});
          await logAction(email,code,"scooter","assigned");
          toast("Scooter assigned.");
        }
      } else if(isBattery){
        if(!data.scooterId){
          toast("Assign a scooter before taking a battery.");
          return;
        }
        if(data.batteryId && data.batteryId!==code){
          toast("Return your current battery first.");
          return;
        }
        if(data.batteryId===code){
          await ref.update({batteryId:firebase.firestore.FieldValue.delete()});
          await logAction(email,code,"battery","returned");
          toast("Battery returned.");
        } else {
          await ref.update({batteryId:code});
          await logAction(email,code,"battery","assigned");
          toast("Battery assigned.");
        }
      } else {
        toast("Invalid QR code.");
      }
    }

    // Log action
    async function logAction(email,deviceId,type,action){
      await db.collection("logs").add({
        email, deviceId, type, action,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  </script>
</body>
</html>

