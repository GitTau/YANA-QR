<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yana QR - Rider Register</title>

  <!-- ========== STYLES ========== -->
  <style>
    /* ---------- Theme & layout ---------- */
    :root{
      --bg:#000;
      --action:#00eaff;
      --muted: #9aa6ac;
      --glass: rgba(255,255,255,0.06);
      --glass2: rgba(255,255,255,0.08);
      --radius: 14px;
    }
    html,body{background:#0a0f12;color:#eaf4f8;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.4}
    *{box-sizing:border-box}
    .container{
      max-width:1100px;margin:28px auto;padding:24px;
    }

    header{
      display:flex;align-items:center;gap:18px;margin-bottom:22px;
    }
    .logo{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
    }
    .brand{font-size:18px;font-weight:600}
    .sub{font-size:12px;color:var(--muted)}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* card */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px;border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);
    }

    /* sign in/out */
    .btn{
      background:var(--action);border:none;color:#001; padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,234,255,0.12);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .small{font-size:13px;padding:8px 10px;border-radius:10px;}

    /* two-column layout */
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:960px){ .grid{grid-template-columns:1fr} .logo{margin-right:auto}}

    /* scanner area */
    .scanner{
      display:flex;flex-direction:column;gap:12px;
    }
    #video{width:100%;border-radius:12px; background:#000; height:360px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .status{padding:8px;border-radius:10px;background:var(--glass);color:var(--muted);font-size:13px}

    /* YANA_RULE: Removed accidental HTML tags that were inside <style>.
       Those tags broke CSS parsing and could impact layout/rendering. */
    /* (No other changes in CSS) */

    /* device info & logs */
    .info-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px}
    .log-list{max-height:380px;overflow:auto;margin-top:8px;padding-right:8px}
    .log-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);margin-bottom:8px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}

    /* input & file */
    .file-input{display:flex;gap:8px;align-items:center}
    .logo-preview{width:56px;height:56px;border-radius:8px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;overflow:hidden}

    /* YANA_ADMIN_CHANGE: registration form styles */
    #registrationUI .form-input{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);color:#fff;outline:none;
    }
    #registrationUI label{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="container">
    <header class="logo card">
      <div style="display:flex;gap:12px;align-items:center">
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <rect x="2" y="2" width="20" height="20" rx="4" fill="#00eaff" />
          <path d="M7 12h10M12 7v10" stroke="#001f23" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div>
        <div class="brand">Yana — Rider QR</div>
        <div class="sub">Scan · Register · Log</div>
      </div>

      <div class="top-actions">
        <div id="user-email" class="muted">Not signed in</div>
        <button id="signinBtn" class="btn small">Sign in with Google</button>
        <button id="signoutBtn" class="btn small ghost" style="display:none">Sign out</button>
      </div>
    </header>

      <!-- YANA_ADMIN_CHANGE: Registration UI (shown when user status = pending) -->
      <div id="registrationUI" class="card" style="display:none; margin-bottom:18px;">
        <div style="font-weight:700;margin-bottom:10px">Rider Registration</div>
        <div class="muted" style="margin-bottom:10px">Please complete your details. Admin will approve your access.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
          <div><div class="muted" style="font-size:12px">Name</div><div id="regName" style="font-weight:600">—</div></div>
          <div><div class="muted" style="font-size:12px">Email</div><div id="regEmail" style="font-weight:600">—</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label class="muted" style="font-size:12px">Phone Number</label>
            <input id="regPhone" class="form-input" type="text" placeholder="Enter phone number">
          </div>
          <div>
            <label class="muted" style="font-size:12px">Aadhar Number</label>
            <input id="regAadhar" class="form-input" type="text" placeholder="Enter Aadhar number">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="submitRegistration" class="btn small">Submit Registration</button>
          <div class="muted" style="font-size:12px">Status: <span id="regStatus">Pending</span></div>
        </div>
      </div>

    <!-- YANA_ADMIN_CHANGE: Added appMain wrapper for gating scanner UI by approval status -->
      <div id="appMain" class="grid">
      <!-- LEFT: Scanner + controls -->
      <div class="card scanner">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Start Scanning</div>
        </div>

        <!-- video preview -->
        <video id="video" playsinline></video>

        <!-- controls -->
        <div class="controls">
          <button id="startCam" class="btn small">Start Camera</button>
          <button id="stopCam" class="btn small ghost">Stop Camera</button>

          <select id="scanMode" class="small" style="background:rgba(255,255,255,0.06);color:#fff;padding:8px;border-radius:10px">
            <option value="auto">Auto-detect</option>
            <option value="scooter">Scooter</option>
            <option value="battery">Battery</option>
          </select>

          <div class="status" id="permissionStatus">Camera idle</div>
        </div>

        <!-- scanner meta -->
        <div class="status">Last decoded: <span id="lastDecoded">—</span></div>
        <div class="status">Parsed: <span id="lastDeviceInfo">—</span></div>

        <!-- submit -->
        <div style="display:flex;gap:8px;align-items:center">
          <button id="submitScan" class="btn">Submit</button>
          <div class="muted">Submits the detected scooter/battery based on the mode</div>
        </div>

        <div class="card" style="padding:12px">
          <div style="font-weight:700">Help</div>
          <div class="muted" style="font-size:13px">Codes like <code>YEV001</code> / <code>YBT001</code> or <code>scooter:YEV001</code> / <code>battery:YBT001</code> work best. Plain IDs are auto-detected.</div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div style="font-weight:700">Scan examples</div>
            <div class="muted" style="margin-top:6px;font-size:12px">Scan → Submit</div>
          </div>
        </div>

        <div class="muted" style="margin-top:8px;font-size:13px">Examples: <code>YEV100</code> / <code>YBT100</code> work best. Plain IDs are auto-detected.</div>

      </div>

      <!-- RIGHT: summary, device status, logs, upload logo -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Rider & Devices</div>
        </div>

        <div style="margin-top:8px">
          <div class="info-row"><div class="muted">Rider</div><div id="riderInfo">—</div></div>
          <div class="info-row"><div class="muted">Linked scooter</div><div id="linkedScooter">—</div></div>
          <div class="info-row"><div class="muted">Linked battery</div><div id="linkedBattery">—</div></div>
        </div>

        <div style="margin-top:14px">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div style="font-weight:700">Recent logs</div>
            <button id="refreshLogs" class="btn small ghost">Refresh</button>
          </div>

          <div class="log-list" id="logList">
            <!-- dynamic logs -->
          </div>
        </div>
      </aside>
    </div>

    <footer class="muted">Built for Yana — keep your riders & devices tracked. Logs saved to Firestore.</footer>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <script>
  /**************************************************************************
   * ========================= IMPORTANT CONFIG ============================
   **************************************************************************/

  const firebaseConfig = {
    apiKey: "AIzaSyCP7KKqJhtauDVonZ-6ApHRitu7CCdV0Ns",
    authDomain: "yana-qr.firebaseapp.com",
    projectId: "yana-qr",
    storageBucket: "yana-qr.firebasestorage.app",
    messagingSenderId: "905613005387",
    appId: "1:905613005387:web:b0d8464d826972654b73ce",
    measurementId: "G-9P9DLJGQHQ"
  };

  // ========== Initialize Firebase ==========
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /**************************************************************************
   * ========================= UI ELEMENTS =================================
   **************************************************************************/
  const video = document.getElementById('video');
  const startCamBtn = document.getElementById('startCam');
  const stopCamBtn = document.getElementById('stopCam');
  const permissionStatus = document.getElementById('permissionStatus');
  const lastDecoded = document.getElementById('lastDecoded');
  const lastDeviceInfo = document.getElementById('lastDeviceInfo');
  const submitScanBtn = document.getElementById('submitScan');
  const scanMode = document.getElementById('scanMode');
  const signinBtn = document.getElementById('signinBtn');
  const signoutBtn = document.getElementById('signoutBtn');
  const userEmailEl = document.getElementById('user-email');
  const riderInfo = document.getElementById('riderInfo');
  const linkedScooter = document.getElementById('linkedScooter');
  const linkedBattery = document.getElementById('linkedBattery');
  const logList = document.getElementById('logList');
  const refreshLogs = document.getElementById('refreshLogs');

  /**************************************************************************
   * ========================= AUTHENTICATION ===============================
   **************************************************************************/

  signinBtn.addEventListener('click', async () => {
    try{
      signinBtn.disabled = true;
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      signinBtn.disabled = false;
    }catch(e){
      console.error('Sign-in failed', e);
      alert('Sign-in failed: '+e.message);
      signinBtn.disabled = false;
    }
  });

  signoutBtn.addEventListener('click', async ()=>{ await auth.signOut(); });

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      userEmailEl.textContent = user.email;
      riderInfo.textContent = `${user.displayName || 'Rider'} (${user.email})`;
      signinBtn.style.display = 'none';
      signoutBtn.style.display = 'inline-block';

      // YANA_ADMIN_CHANGE: ensure user doc exists with registration fields and status gating
      const uDocRef = db.collection('users').doc(user.email);

  // YANA_ADMIN_CHANGE: Show correct UI based on user status and load data accordingly
  async function checkUserStatus(email, displayName) {
    try{
      const userRef = db.collection('users').doc(email);
      const snap = await userRef.get();
      if(!snap.exists){ 
        // Should not happen, but keep scanner hidden just in case
        document.getElementById('appMain').style.display = 'none';
        document.getElementById('registrationUI').style.display = 'none';
        return;
      }
      const data = snap.data() || {};
      if(data.status === 'approved'){
        // Show main app, hide registration
        document.getElementById('appMain').style.display = '';
        document.getElementById('registrationUI').style.display = 'none';
        // load rider & logs views
        loadUserDevices();
        loadLogs();
      } else if(data.status === 'pending' || !data.status){
        // Hide app, show registration
        document.getElementById('appMain').style.display = 'none';
        document.getElementById('registrationUI').style.display = '';
        document.getElementById('regName').textContent = displayName || '';
        document.getElementById('regEmail').textContent = email || '';
        document.getElementById('regStatus').textContent = 'Pending';
      } else if(data.status === 'rejected'){
        document.getElementById('appMain').style.display = 'none';
        document.getElementById('registrationUI').style.display = 'none';
        alert('Your registration has been rejected. Please contact support.');
      } else {
        // unknown state -> default to pending UI
        document.getElementById('appMain').style.display = 'none';
        document.getElementById('registrationUI').style.display = '';
      }
    }catch(e){
      console.error('Status check error', e);
    }
  }

  // YANA_ADMIN_CHANGE: Registration submit handler (saves phone & aadhar, remains pending for admin approval)
  (function attachRegistrationHandler(){
    const btn = document.getElementById('submitRegistration');
    if(!btn) return;
    btn.addEventListener('click', async ()=>{
      try{
        const u = auth.currentUser;
        if(!u){ alert('Please sign in first'); return; }
        const phone = (document.getElementById('regPhone').value||'').trim();
        const aadhar = (document.getElementById('regAadhar').value||'').trim();
        if(!phone || !aadhar){
          alert('Please enter phone and aadhar.');
          return;
        }
        await db.collection('users').doc(u.email).set({
          phone, aadhar, status:'pending'
        }, { merge:true });
        document.getElementById('regStatus').textContent = 'Pending (submitted)';
        alert('Registration submitted. Wait for admin approval.');
      }catch(err){
        console.error('Registration submit error', err);
        alert('Failed to submit registration.');
      }
    });
  })();
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(uDocRef);
        if (!snap.exists) {
          tx.set(uDocRef, {
            email: user.email,
            name: user.displayName || "",
            phone: null,
            aadhar: null,
            status: "pending",
            linkedScooter: null,
            linkedBattery: null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });
      // YANA_ADMIN_CHANGE: Decide which UI to show
      checkUserStatus(user.email, user.displayName);
    } else {
      userEmailEl.textContent = 'Not signed in';
      riderInfo.textContent = '—';
      linkedScooter.textContent = '—';
      linkedBattery.textContent = '—';
      signinBtn.style.display = 'inline-block';
      signoutBtn.style.display = 'none';
      logList.innerHTML = '';
      // YANA_ADMIN_CHANGE: hide both main app and registration when signed out
      const appMainEl = document.getElementById('appMain');
      const regEl = document.getElementById('registrationUI');
      if(appMainEl) appMainEl.style.display = 'none';
      if(regEl) regEl.style.display = 'none';
    }
  });

  /**************************************************************************
   * ========================= CAMERA & QR SCANNER ==========================
   **************************************************************************/
  let stream = null;
  let scanning = false;
  let scanInterval = null;
  let lastRawResult = null;
  let lastParsedResult = { type: 'unknown', id: '', raw: '' };

  // YANA_CHANGED: Throttle flag to avoid spamming logs for repeated unknown codes during scanning.
  let lastUnknownIdLogged = null; // only log to Firestore when the unknown ID changes

  async function startCamera(){
    try{
      permissionStatus.textContent = 'Requesting camera...';
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      video.srcObject = stream;
      await video.play();
      permissionStatus.textContent = 'Camera active';
      startCamBtn.style.display = 'none';
      stopCamBtn.style.display = 'inline-block';
      scanning = true;
      scanLoop();
    }catch(err){
      console.error('Camera error', err);
      permissionStatus.textContent = 'Camera permission denied or not available';
      alert('Camera access is required for scanning. Please allow camera permissions and try again.');
    }
  }
  function stopCamera(){
    scanning = false;
    permissionStatus.textContent = 'Camera stopped';
    startCamBtn.style.display = 'inline-block';
    stopCamBtn.style.display = 'none';
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    if(scanInterval){ clearInterval(scanInterval); scanInterval = null; }
  }
  startCamBtn.addEventListener('click', startCamera);
  stopCamBtn.addEventListener('click', stopCamera);

  function scanLoop(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d',{ willReadFrequently:true });
    scanInterval = setInterval(async ()=>{
      if(!scanning || !video.videoWidth) return;
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if(code && code.data && code.data !== lastRawResult){
        lastRawResult = code.data;
        lastDecoded.textContent = code.data;
        const parsed = await parsePayload(code.data);
        lastParsedResult = parsed;
        lastDeviceInfo.textContent = `${parsed.type} → ${parsed.id || '—'}`;
      }
    }, 400);
  }

  /**************************************************************************
   * ========================= QR PARSE ====================================
   **************************************************************************/
  async function parsePayload(raw){
    // Accept 'scooter:ID' or 'battery:ID' and new YEVxxx / YBTxxx
    const rawTrim = (raw||'').trim();
    if(!rawTrim){ return { type:'unknown', id:'', raw:rawTrim }; }

    // YANA_RULE: Accept both new and legacy formats robustly
    // 1) direct patterns like "YEV001" / "YBT001"
    let m = rawTrim.match(/^(YEV\d+|YBT\d+)$/i);
    if(m){
      const id = m[1].toUpperCase();
      const type = /^YEV/i.test(id) ? 'scooter' : 'battery';
      return { type, id, raw: rawTrim, source:'direct_pattern' };
    }

    // 2) legacy 'scooter:ID' or 'battery:ID'
    m = rawTrim.match(/^(scooter|battery)\s*:\s*([A-Za-z0-9_-]+)$/i);
    if(m){
      const id = m[2].toUpperCase();
      const type = m[1].toLowerCase();
      return { type, id, raw: rawTrim, source:'legacy_prefix' };
    }

    // 3) Heuristics for plain ids
    try{
      const id = rawTrim.toUpperCase().replace(/[^A-Z0-9:_-]/g, '');
      if(/^YEV\d+/i.test(id) || /^SCOOT/i.test(id) || /^SCOOTER/i.test(id)) {
        return { type: 'scooter', id, raw: rawTrim };
      }
      if(/^YBT\d+/i.test(id) || /^BAT\d+|^BATTERY/i.test(id)) {
        return { type: 'battery', id, raw: rawTrim };
      }
    } catch (e) {
      console.warn('Heuristic check failed', e);
    }

    try {
      const scooterRef = db.collection('devices').doc(`scooter_${id}`);
      const batteryRef = db.collection('devices').doc(`battery_${id}`);
      const [sSnap, bSnap] = await Promise.all([scooterRef.get(), batteryRef.get()]);
      if(sSnap.exists){ return { type: 'scooter', id, raw: rawTrim, source: 'devices_collection' }; }
      if(bSnap.exists){ return { type: 'battery', id, raw: rawTrim, source: 'devices_collection' }; }

      // YANA_CHANGED: log unknown QR once per ID (throttled) so we can trace bad stickers/prints.
      if(lastUnknownIdLogged !== id){
        lastUnknownIdLogged = id;
        const u = auth.currentUser;
        logOutOfBand({
          email: u ? u.email : null,
          action: 'unknown_qr',
          deviceType: 'unknown',
          deviceId: id,
          rawPayload: rawTrim
        });
        console.warn('Unknown device id scanned:', id);
        permissionStatus.textContent = `Unknown QR: ${id}`;
      }
    } catch(e){
      console.warn('devices lookup failed', e);
    }

    return { type:'unknown', id:'', raw:rawTrim };
  }

  /**************************************************************************
   * ========================= SUBMIT LOGIC ================================
   **************************************************************************/
  submitScanBtn.addEventListener('click', async ()=>{
    const mode = scanMode.value;
    if(lastParsedResult.type === 'unknown' || !lastParsedResult.id){
      alert('No valid scooter/battery detected yet.');
      return;
    }
    if(mode !== 'auto' && mode !== lastParsedResult.type){
      alert(`Scan mode is "${mode}" but QR parsed as "${lastParsedResult.type}". Please fix mode or rescan.`);
      return;
    }
    try{
      if(lastParsedResult.type === 'scooter'){
        await assignOrReturnScooter(lastParsedResult.id, lastParsedResult.raw);
      } else if(lastParsedResult.type === 'battery'){
        await assignOrReturnBattery(lastParsedResult.id, lastParsedResult.raw);
      }
    }catch(err){
      console.error(err);
      alert(err.message || 'Submit failed.');
    }
  });

  /**************************************************************************
   * ========================= TRANSACTION HELPERS ==========================
   **************************************************************************/
  function userDocRef(email){ return db.collection('users').doc(email); }
  function scootyDocRef(scooterId){ return db.collection('scooties').doc(scooterId); }
  function batteryDocRef(batteryId){ return db.collection('batteries').doc(batteryId); }
  const logsRef = db.collection('logs');

  async function logOutOfBand(d){
    try{ await logsRef.add({ ts: firebase.firestore.FieldValue.serverTimestamp(), ...d }); }
    catch(e){ console.warn('logOutOfBand failed', e); }
  }

  async function loadUserDevices(){
    const u = auth.currentUser;
    if(!u) return;
    const snap = await userDocRef(u.email).get();
    const data = snap.exists ? snap.data() : {};
    riderInfo.textContent = `${u.displayName || 'Rider'} (${u.email})`;
    linkedScooter.textContent = data.linkedScooter || '—';
    linkedBattery.textContent = data.linkedBattery || '—';
  }

  async function loadLogs(){
    logList.innerHTML = '';
    const q = await logsRef.orderBy('ts', 'desc').limit(25).get();
    q.forEach(doc=>{
      const d = doc.data() || {};
      const el = document.createElement('li');
      el.className = 'log-item';
      el.innerHTML = `<div style="font-weight:600">${(d.action||'').replace(/_/g,' ')}</div>
      <div class="muted">${d.deviceType || '-'} • ${d.deviceId || '-'}</div>
      <div class="muted" style="margin-top:6px">user: ${d.email || '-'}</div>`;
      logList.appendChild(el);
    });
  }

  /**************************************************************************
   * ========================= SCOOTER ASSIGN/RETURN =======================
   **************************************************************************/
  async function assignOrReturnScooter(scooterId, rawPayload){
    if(!scooterId) throw new Error('Invalid scooter id');
    const u = auth.currentUser;
    if(!u) throw new Error('Not signed in');

    await db.runTransaction(async (tx)=>{
      const email = u.email;
      const userRef = userDocRef(email);
      const scootyRef = scootyDocRef(scooterId);

      const [userSnap, scootySnap] = await Promise.all([tx.get(userRef), tx.get(scootyRef)]);
      if(!userSnap.exists){ throw new Error('User record missing'); }
      const user = userSnap.data() || {};

      // YANA_CHANGED: Auto-heal: if a scooter has a battery but no rider, clear it.
      if(scootySnap.exists){
        const s = scootySnap.data() || {};
        if(s.currentBatteryId && !s.currentRiderEmail){
          tx.set(scootyRef, { currentBatteryId:null, status:'free' }, { merge:true });
        }
      }

      let scooty;
      if(!scootySnap.exists){
        scooty = {
          scootyId: scooterId,
          currentBatteryId: null,
          currentRiderEmail: null,
          status: 'free'
        };
        tx.set(scootyRef, scooty);
      } else {
        scooty = scootySnap.data();
      }

      // === CASE 1: returning scooter ===
      if(user.linkedScooter === scooterId){
      if(!scooty.currentBatteryId){
        tx.set(logsRef.doc(), {
          ts: firebase.firestore.FieldValue.serverTimestamp(),
          email, action:'error_missing_battery_on_return',
          deviceType:'scooter', deviceId:scooterId, rawPayload
        });
        throw new Error("Scooter return requires a battery linked.");
      }
      // Clear user, scooter, battery
      tx.set(userRef, { linkedScooter:null, linkedBattery:null }, { merge:true });
      tx.set(scootyRef, {
        scootyId:scooterId, currentRiderEmail:null,
        currentBatteryId:null, status:'free'
      }, { merge:true });
      const batteryRef = db.collection('batteries').doc(scooty.currentBatteryId);
      tx.set(batteryRef, {
        batteryId:scooty.currentBatteryId,
        assignedScootyId:null, assignedRiderEmail:null,
        status:'free'
      }, { merge:true });
      tx.set(logsRef.doc(), {
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        email, action:'return_scooter',
        deviceType:'scooter', deviceId:scooterId, rawPayload
      });
      return;
    }

      // === CASE 2: assigning scooter ===
      if(user.linkedScooter){
        throw new Error("You already have a scooter assigned.");
      }
      if(scooty.currentRiderEmail && scooty.currentRiderEmail !== email){
        throw new Error("This scooter is already assigned to another rider.");
      }

      tx.set(userRef, { linkedScooter: scooterId }, { merge:true });
      tx.set(scootyRef, { currentRiderEmail: email, status:'assigned' }, { merge:true });

      tx.set(logsRef.doc(), {
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        email, action:'assign_scooter',
        deviceType:'scooter', deviceId:scooterId, rawPayload
      });
    });

    await loadUserDevices();
    await loadLogs();
  }

  /**************************************************************************
   * ========================= BATTERY ASSIGN/RETURN =======================
   **************************************************************************/
  async function assignOrReturnBattery(batteryId, rawPayload){
    if(!batteryId) throw new Error('Invalid battery id');
    const u = auth.currentUser;
    if(!u) throw new Error('Not signed in');

    await db.runTransaction(async (tx)=>{
      const email = u.email;
      const userRef = userDocRef(email);
      const userSnap = await tx.get(userRef);
      if(!userSnap.exists) throw new Error('User missing');
      const user = userSnap.data() || {};

      if(!user.linkedScooter){
        throw new Error("Assign a scooter first.");
      }

      const batteryRef = batteryDocRef(batteryId);
      const scootyRef = scootyDocRef(user.linkedScooter);

      const [batterySnap, scootySnap] = await Promise.all([tx.get(batteryRef), tx.get(scootyRef)]);
      let battery = batterySnap.exists ? (batterySnap.data()||{}) : {
        batteryId, assignedScootyId:null, assignedRiderEmail:null, status:'free'
      };
      let scooty = scootySnap.exists ? (scootySnap.data()||{}) : { scootyId:user.linkedScooter, currentBatteryId:null, currentRiderEmail:email, status:'assigned' };

      // === CASE 1: returning only battery ===
      if(user.linkedBattery === batteryId){
        if(scooty.currentBatteryId !== batteryId){
          throw new Error("Invalid state: rider battery doesn't match scooter battery");
        }
        tx.set(userRef, { linkedBattery:null }, { merge:true });
        tx.set(scootyRef, { currentBatteryId:null, status:'assigned' }, { merge:true });
        tx.set(batteryRef, { assignedScootyId:null, assignedRiderEmail:null, status:'free' }, { merge:true });
        tx.set(logsRef.doc(), {
          ts:firebase.firestore.FieldValue.serverTimestamp(),
          email, action:'return_battery',
          deviceType:'battery', deviceId:batteryId, rawPayload
        });
        return;
      }

      // === CASE 2: assigning new battery ===
      if(user.linkedBattery && user.linkedBattery !== batteryId){
        throw new Error("Please return your current battery first.");
      }
      if(battery.assignedRiderEmail && battery.assignedRiderEmail !== email){
        throw new Error("This battery is already assigned to another rider.");
      }
      if(battery.assignedScootyId && battery.assignedScootyId !== user.linkedScooter){
        throw new Error("This battery is already assigned to another scooter.");
      }
      if(scooty.currentBatteryId && scooty.currentBatteryId !== batteryId){
        throw new Error("This scooter already has a different battery.");
      }

      // Write all 3 sides
      tx.set(userRef, { linkedBattery:batteryId }, { merge:true });
      tx.set(batteryRef, {
        batteryId, assignedScootyId:user.linkedScooter,
        assignedRiderEmail:email, status:'assigned'
      }, { merge:true });
      tx.set(scootyRef, { currentBatteryId:batteryId, status:'assigned' }, { merge:true });
      tx.set(logsRef.doc(), {
        ts:firebase.firestore.FieldValue.serverTimestamp(),
        email, action:'assign_battery',
        deviceType:'battery', deviceId:batteryId, rawPayload
      });
    });

    await loadUserDevices();
    await loadLogs();
  }

  /**************************************************************************
   * ========================= LOG VIEW REFRESH ============================
   **************************************************************************/
  refreshLogs.addEventListener('click', loadLogs);

  /**************************************************************************
   * ========================= MISC ========================================
   **************************************************************************/
  function escapeHtml(s){ return (s+'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  window.addEventListener('beforeunload', ()=>{ if(stream) stream.getTracks().forEach(t=>t.stop()); });

  (async ()=>{ /* onAuthStateChanged handles initial UI */ })();
  </script>
</body>
</html>
