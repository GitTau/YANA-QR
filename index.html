<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YANA QR App</title>

<!-- Manifest only when allowed -->
<script>
if (location.protocol === 'http:' || location.protocol === 'https:') {
  const manifest = document.createElement('link');
  manifest.rel = 'manifest';
  manifest.href = 'manifest.json';
  document.head.appendChild(manifest);
} else {
  console.warn("Skipping manifest.json in file:// mode");
}
</script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; margin-top: 10px; }
input, button { margin: 5px 0; padding: 8px; }
video { width: 100%; max-width: 400px; margin-top: 10px; }
</style>
</head>
<body>

<h2>YANA QR App</h2>

<input type="email" id="email" placeholder="Email"><br>
<input type="password" id="password" placeholder="Password"><br>
<button id="btnRegister">Register</button>
<button id="btnSignIn">Sign In</button>
<button id="btnSignOut">Sign Out</button>

<h3>QR Scanner</h3>
<video id="preview"></video>
<button id="btnScan">Start Scan</button>

<div id="log"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCP7KKqJhtauDVonZ-6ApHRitu7CCdV0Ns",
  authDomain: "yana-qr.firebaseapp.com",
  projectId: "yana-qr",
  storageBucket: "yana-qr.firebasestorage.app",
  messagingSenderId: "905613005387",
  appId: "1:905613005387:web:b0d8464d826972654b73ce",
 
};

let auth, db, currentUser;

// Init Firebase only for http/https
if (location.protocol === 'http:' || location.protocol === 'https:') {
  const app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
} else {
  console.warn("Firebase init skipped in file:// mode");
}

function log(msg, type='info') {
  const logBox = document.getElementById('log');
  const div = document.createElement('div');
  div.innerHTML = msg;
  div.style.color = type === 'err' ? 'red' : (type === 'ok' ? 'green' : 'black');
  logBox.appendChild(div);
  logBox.scrollTop = logBox.scrollHeight;
}

// Register
document.getElementById('btnRegister').onclick = async () => {
  try {
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    currentUser = cred.user;
    log(`‚úÖ Registered: ${currentUser.email}`, 'ok');
  } catch (e) {
    log(`‚ùå ${e.message}`, 'err');
  }
};

// Sign In
document.getElementById('btnSignIn').onclick = async () => {
  try {
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    currentUser = cred.user;
    log(`üîê Signed in as ${currentUser.email}`, 'ok');
  } catch (e) {
    log(`‚ùå ${e.message}`, 'err');
  }
};

// Sign Out
document.getElementById('btnSignOut').onclick = async () => {
  await auth.signOut();
  currentUser = null;
  log("üö™ Signed out", 'ok');
};

// QR Scan
document.getElementById('btnScan').onclick = () => {
  if (!currentUser) return log("Sign in first!", 'err');

  const html5QrCode = new Html5Qrcode("preview");
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      html5QrCode.start(
        cameras[0].id,
        { fps: 10, qrbox: 250 },
        async qrCodeMessage => {
          log(`üì∑ Scanned: ${qrCodeMessage}`, 'ok');
          await handleScan(qrCodeMessage);
          html5QrCode.stop();
        },
        error => {}
      );
    }
  }).catch(err => log(err, 'err'));
};

// Handle scan (register/deregister)
async function handleScan(code) {
  const docRef = db.collection("registrations").doc(code);
  const docSnap = await docRef.get();

  if (!docSnap.exists) {
    // Register
    await docRef.set({
      type: code.toLowerCase().includes("battery") ? "battery" : "scooter",
      assignedTo: currentUser.email,
      timestamp: new Date(),
      action: "registered"
    });
    log(`‚úÖ Registered ${code} to ${currentUser.email}`, 'ok');
  } else {
    // Deregister
    await docRef.delete();
    log(`üóëÔ∏è Deregistered ${code}`, 'ok');

    // Log history
    await db.collection("logs").add({
      code,
      action: "deregistered",
      by: currentUser.email,
      timestamp: new Date()
    });
  }
}
</script>

</body>
</html>
