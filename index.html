<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yana Scan â€” Google Login + Firebase</title>
<style>
:root{
  --bg:#000;
  --action:#00eaff;
  --muted:#bfc6c9;
}
body {background:var(--bg);color:var(--muted);margin:0;font-family:Arial;}
.app {max-width:900px;margin:auto;padding:20px;}
h1{color:white;}
button {padding:10px 15px;border:none;border-radius:8px;cursor:pointer;}
button.primary {background:var(--action);color:black;font-weight:bold;}
.hidden{display:none;}
#reader{margin-top:10px;border:1px solid var(--muted);}
.log{margin-top:10px;font-size:14px;}
.log-item{margin-bottom:6px;}
</style>
<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script type="module">
// ==== Firebase Imports ====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

// ==== Firebase Config ====
const firebaseConfig = {
  apiKey: "AIzaSyCP7KKqJhtauDVonZ-6ApHRitu7CCdV0Ns",
  authDomain: "yana-qr.firebaseapp.com",
  projectId: "yana-qr",
  storageBucket: "yana-qr.firebasestorage.app",
  messagingSenderId: "905613005387",
  appId: "1:905613005387:web:b0d8464d826972654b73ce",
  measurementId: "G-9P9DLJGQHQ"
};

// ==== Init Firebase ====
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ==== UI Elements ====
const signInBtn = document.getElementById("googleSignIn");
const signOutBtn = document.getElementById("signOut");
const userInfo = document.getElementById("userInfo");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const logDiv = document.getElementById("log");
let html5QrCode = null;
let currentUserEmail = null;

// ==== Auth Events ====
signInBtn.addEventListener("click", () => {
  signInWithPopup(auth, provider)
    .then(result => {
      console.log("Signed in:", result.user.email);
    })
    .catch(err => console.error(err));
});

signOutBtn.addEventListener("click", () => {
  signOut(auth);
});

onAuthStateChanged(auth, user => {
  if(user){
    currentUserEmail = user.email;
    userInfo.textContent = `Signed in as ${currentUserEmail}`;
    signInBtn.classList.add("hidden");
    signOutBtn.classList.remove("hidden");
    startBtn.disabled = false;
  } else {
    currentUserEmail = null;
    userInfo.textContent = "Not signed in";
    signInBtn.classList.remove("hidden");
    signOutBtn.classList.add("hidden");
    startBtn.disabled = true;
  }
});

// ==== QR Scanner ====
startBtn.addEventListener("click", async () => {
  if(!currentUserEmail){alert("Please sign in first!");return;}
  if(!html5QrCode){
    html5QrCode = new Html5Qrcode("reader");
  }
  html5QrCode.start({ facingMode: "environment" }, { fps:10, qrbox:250 },
    onScanSuccess, err => {});
});

stopBtn.addEventListener("click", async () => {
  if(html5QrCode){
    await html5QrCode.stop();
    html5QrCode.clear();
    html5QrCode = null;
  }
});

async function onScanSuccess(decodedText){
  const [type, id] = decodedText.trim().split(":");
  if(!type || !id){ addLog("Invalid QR"); return; }
  await handleDeviceToggle(type.toLowerCase(), id, currentUserEmail);
}

function addLog(msg){
  const div = document.createElement("div");
  div.className="log-item";
  div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logDiv.prepend(div);
}

// ==== Firestore Device Logic ====
async function handleDeviceToggle(type, id, email){
  const deviceRef = doc(db, "devices", `${type}_${id}`);
  const deviceSnap = await getDoc(deviceRef);
  if(!deviceSnap.exists()){
    await setDoc(deviceRef, {type,id,currentRiderEmail:email,lastUpdated:serverTimestamp()});
    await addDoc(collection(db, "logs"), {action:"register",type,id,email,timestamp:serverTimestamp()});
    addLog(`Registered ${type} ${id} to ${email}`);
    return;
  }
  const data = deviceSnap.data();
  if(data.currentRiderEmail === email){
    await updateDoc(deviceRef, {currentRiderEmail:null,lastUpdated:serverTimestamp()});
    await addDoc(collection(db, "logs"), {action:"deregister",type,id,email,timestamp:serverTimestamp()});
    addLog(`Deregistered ${type} ${id} from ${email}`);
  } else {
    await updateDoc(deviceRef, {currentRiderEmail:email,lastUpdated:serverTimestamp()});
    await addDoc(collection(db, "logs"), {action:"register",type,id,email,timestamp:serverTimestamp()});
    addLog(`Registered ${type} ${id} to ${email}`);
  }
}
</script>
</head>
<body>
<div class="app">
  <h1>Yana Scan</h1>
  <p id="userInfo">Not signed in</p>
  <button id="googleSignIn" class="primary">Sign in with Google</button>
  <button id="signOut" class="hidden">Sign Out</button>
  <br><br>
  <button id="startBtn" class="primary" disabled>Start Scanning</button>
  <button id="stopBtn">Stop</button>
  <div id="reader"></div>
  <div class="log" id="log"></div>
</div>
</body>
</html>
